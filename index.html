<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gestão de Clientes e Encomendas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { margin:0; background:#f3f4f6; font-family:sans-serif;}
    .container { max-width:1000px; margin:36px auto; background:#fff; border-radius:10px; box-shadow:0 2px 8px #0003; padding:32px 24px;}
    h1 { margin-top:0;}
    .panel { background:#f6f8fa; border-radius:8px; margin-bottom:30px; padding:18px 22px; box-shadow:0 1px 4px #0001;}
    .panel h2 { margin-top:0; font-size:1.2em;}
    table { width:100%; border-collapse:collapse; background:#fff;}
    th, td { padding:10px 8px; border-bottom:1px solid #eee; text-align:left;}
    th { background:#f9fafb; font-weight:600; }
    tr:last-child td { border-bottom:none;}
    .actions button { margin-right:5px; padding:4px 10px; border-radius:4px; border:none; font-size:0.95em; cursor:pointer;}
    .actions .edit { background:#2563eb; color:#fff;}
    .actions .delete { background:#dc2626; color:#fff;}
    .actions .view { background:#10b981; color:#fff;}
    .floating-btn {
      background:#2563eb; color:#fff; border:none; border-radius:100px; font-size:1.3em; width:40px; height:40px;
      position:absolute; right:24px; top:18px; cursor:pointer; box-shadow:0 2px 8px #2563eb29;
    }
    .modal-bg {
      background:rgba(0,0,0,0.18); position:fixed; inset:0; display:none; z-index:50;
    }
    .modal-bg.active { display:flex; align-items:center; justify-content:center; }
    .modal {
      background:#fff; padding:32px 26px 20px 26px; border-radius:8px; min-width:340px; min-height:120px; box-shadow:0 2px 12px #0003;
      display:flex; flex-direction:column; gap:14px; position:relative;
    }
    .modal-close {
      position:absolute; top:10px; right:10px; background:none; border:none; font-size:1.3em; color:#aaa; cursor:pointer;
    }
    .modal label { display:block; margin-bottom:8px;}
    .modal input, .modal textarea {
      width:100%; font-size:1em; padding:8px; border:1px solid #dbdbdb; border-radius:4px; margin-bottom:10px;
    }
    .modal-actions { margin-top:12px; display:flex; justify-content:flex-end; gap:10px;}
    .modal-actions button {
      font-size:1em; padding:7px 20px; border-radius:6px; border:none; cursor:pointer;
    }
    .modal-actions .save { background:#2563eb; color:#fff;}
    .modal-actions .cancel { background:#e5e7eb; color:#333;}
    .notification {
      position:fixed; right:24px; top:24px; background:#2563eb; color:#fff; padding:15px 28px; border-radius:7px; font-size:1.1em;
      z-index:200; box-shadow:0 2px 12px #0003; opacity:0.97; display:none;
    }
    .notification.error { background:#dc2626;}
    .req-list { margin:0; padding-left:22px; }
    .req-list li { margin-bottom:2px;}
    .req-actions button {
      background: #f59e42; color:#fff; border:none; border-radius:4px; padding:2px 7px; font-size:0.92em; margin-left: 6px; cursor:pointer;
    }
    .req-actions .edit { background:#2563eb;}
    .req-actions .delete { background:#dc2626;}
    .req-add-form { display: flex; gap: 8px; margin-top: 8px;}
    .req-add-form input { flex: 1; }
    @media (max-width:700px) { .container { padding:10px 3vw;} .modal { min-width:90vw; } }
  </style>
</head>
<body>
<div class="container">
  <h1>Clientes e Encomendas</h1>
  <div class="panel" style="position:relative;">
    <h2>Clientes</h2>
    <button class="floating-btn" onclick="openClientModal()">+</button>
    <table>
      <thead>
        <tr><th>Nome</th><th>Contacto</th><th>Pedidos</th><th>Ações</th></tr>
      </thead>
      <tbody id="clients-list"></tbody>
    </table>
  </div>
</div>
<!-- MODAL -->
<div class="modal-bg" id="modal-bg">
  <form class="modal" id="modal-form" onsubmit="return modalSave(event)">
    <button type="button" class="modal-close" onclick="closeModal()">&times;</button>
    <div id="modal-title" style="font-weight:600;font-size:1.1em;"></div>
    <div id="modal-body"></div>
    <div class="modal-actions" id="modal-actions"></div>
  </form>
</div>
<!-- NOTIFICATION -->
<div class="notification" id="notification"></div>
<script>
const LS_CLIENTS = 'clients_and_requests_better_v2';
function getClients() { return JSON.parse(localStorage.getItem(LS_CLIENTS)||'[]'); }
function setClients(arr) { localStorage.setItem(LS_CLIENTS, JSON.stringify(arr)); }
function showNotification(msg, isError) {
  let n = document.getElementById('notification');
  n.textContent = msg;
  n.className = "notification"+(isError?" error":"");
  n.style.display = "block";
  setTimeout(()=>{ n.style.display = "none"; }, 1900);
}
function renderClients() {
  let clients = getClients();
  let tbody = '';
  for(let c of clients) {
    tbody += `<tr>
      <td><a href="#" style="color:#2563eb;text-decoration:underline;" onclick="showClientDetail('${c.id}');return false;">${c.name}</a></td>
      <td>${c.contact}</td>
      <td>${c.requests?.length || 0}</td>
      <td class="actions">
        <button class="view" onclick="showClientDetail('${c.id}')">Ver</button>
        <button class="edit" onclick="openClientModal('${c.id}')">Editar</button>
        <button class="delete" onclick="deleteClient('${c.id}')">Remover</button>
      </td>
    </tr>`;
  }
  document.getElementById('clients-list').innerHTML = tbody;
}
// MODALS
let modalContext = {};
function openClientModal(editId) {
  let c = {name:"", contact:"", requests:[]}, edit=false;
  if(editId) {
    c = getClients().find(x=>x.id===editId) || c;
    edit = true;
  }
  let requestsInput = !edit ? `<label>Primeiro pedido do cliente:<textarea id="cli-requests" rows="2" placeholder="Ex: Orçamento para 10 lâmpadas"></textarea></label>` : "";
  document.getElementById('modal-title').innerHTML = edit ? "Editar Cliente" : "Novo Cliente";
  document.getElementById('modal-body').innerHTML =
    `<label>Nome: <input id="cli-name" value="${c.name}" required></label>
     <label>Contacto: <input id="cli-contact" value="${c.contact}" required></label>
     ${requestsInput}`;
  document.getElementById('modal-actions').innerHTML =
    `<button type="button" class="cancel" onclick="closeModal()">Cancelar</button>
     <button type="submit" class="save">${edit ? "Guardar" : "Adicionar"}</button>`;
  modalContext = {
    saveHandler: ()=>{
      let name = document.getElementById('cli-name').value.trim();
      let contact = document.getElementById('cli-contact').value.trim();
      if(!name || !contact) { showNotification("Nome e contacto obrigatórios.",1); return false;}
      let clients = getClients();
      if(edit) {
        let idx = clients.findIndex(x=>x.id===editId);
        clients[idx] = {...clients[idx], name, contact};
      } else {
        let id = "C"+Date.now();
        let reqs = document.getElementById('cli-requests').value.trim();
        let requests = reqs ? reqs.split(/\n|;/).map(e=>e.trim()).filter(Boolean) : [];
        clients.push({id, name, contact, requests});
      }
      setClients(clients); renderClients(); closeModal();
      showNotification("Cliente salvo!");
      return false;
    }
  };
  document.getElementById('modal-bg').classList.add('active');
}
function showClientDetail(clientId) {
  let clients = getClients();
  let c = clients.find(x=>x.id===clientId);
  if(!c) return;
  document.getElementById('modal-title').innerHTML = `Cliente: ${c.name}`;
  let reqList = (c.requests||[]).map((r,i)=>`
    <li id="req-li-${i}">
      <span id="req-span-${i}">${r}</span>
      <span class="req-actions">
        <button class="edit" onclick="editRequest('${c.id}',${i})">Editar</button>
        <button class="delete" onclick="removeRequest('${c.id}',${i})">Remover</button>
      </span>
    </li>
  `).join("");
  document.getElementById('modal-body').innerHTML =
    `<b>Contacto:</b> ${c.contact}<br><b>Pedidos:</b>
    <ul class="req-list" id="req-list-detail">${reqList || '<i>Nenhum pedido registrado.</i>'}</ul>
    <form class="req-add-form" onsubmit="return addRequestFromDetail('${c.id}')">
      <input id="req-input-detail" placeholder="Novo pedido..." required>
      <button type="submit" class="save" style="padding:4px 12px;">Adicionar</button>
    </form>`;
  document.getElementById('modal-actions').innerHTML =
    `<button type="button" class="cancel" onclick="closeModal()">Fechar</button>
     <button type="button" class="edit" onclick="openClientModal('${c.id}')">Editar Cliente</button>
     <button type="button" class="delete" onclick="deleteClient('${c.id}')">Remover Cliente</button>`;
  modalContext = {};
  document.getElementById('modal-bg').classList.add('active');
}
function addRequestFromDetail(clientId) {
  let val = document.getElementById('req-input-detail').value.trim();
  if(!val) return false;
  let clients = getClients();
  let idx = clients.findIndex(x=>x.id===clientId);
  if(idx<0) return false;
  if(!Array.isArray(clients[idx].requests)) clients[idx].requests = [];
  clients[idx].requests.push(val);
  setClients(clients);
  showClientDetail(clientId);
  showNotification("Pedido adicionado!");
  return false;
}
function editRequest(clientId, reqIdx) {
  let clients = getClients();
  let c = clients.find(x=>x.id===clientId);
  let old = c?.requests?.[reqIdx] || "";
  let span = document.getElementById(`req-span-${reqIdx}`);
  if(!span) return;
  span.innerHTML = `<input id="edit-req-input" value="${old}" style="width:80%;"> <button onclick="saveReqEdit('${clientId}',${reqIdx})" class="save" style="padding:2px 10px;">Salvar</button>`;
}
function saveReqEdit(clientId, reqIdx) {
  let val = document.getElementById('edit-req-input').value.trim();
  if(!val) return false;
  let clients = getClients();
  let cidx = clients.findIndex(x=>x.id===clientId);
  if(cidx<0) return false;
  clients[cidx].requests[reqIdx] = val;
  setClients(clients);
  showClientDetail(clientId);
  showNotification("Pedido atualizado!");
  return false;
}
function removeRequest(clientId, reqIdx) {
  if(!confirm("Remover este pedido?")) return;
  let clients = getClients();
  let idx = clients.findIndex(x=>x.id===clientId);
  if(idx<0) return;
  clients[idx].requests.splice(reqIdx,1);
  setClients(clients); showClientDetail(clientId); renderClients();
  showNotification("Pedido removido.");
}
function deleteClient(id) {
  if(!confirm("Remover cliente? Isso apagará também todos os pedidos.")) return;
  let clients = getClients().filter(x=>x.id!==id);
  setClients(clients); renderClients();
  closeModal();
  showNotification("Cliente removido.");
}
function closeModal() {
  document.getElementById('modal-bg').classList.remove('active');
  modalContext = {};
}
function modalSave(e) {
  e.preventDefault();
  if(modalContext.saveHandler) return modalContext.saveHandler();
  return false;
}
// Bootstrap
window.onload = function() {
  if(!localStorage.getItem(LS_CLIENTS)) {
    setClients([
      {id:"C1", name:"João Silva", contact:"912345678", requests:["Orçamento para 10 lâmpadas LED", "Entrega em Lisboa"]},
      {id:"C2", name:"Maria Oliveira", contact:"932345678", requests:["Cotação para 3 cadeiras gamer", "Pergunta sobre garantia"]}
    ]);
  }
  renderClients();
};
</script>
</body>
</html>
